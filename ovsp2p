#!/usr/bin/nu

let pids = podman ps --ns --format=json | from json | get Pid

let ovspid = sudo docker inspect -f '{{.State.Pid}}' ovs-test

let pid1 = $pids | get 0

let pid2 = $pids | get 1

print ($pids)

let nsovs = "nsovs"

# setup bridge br0

let hostovs = "hostovs"

sudo ip netns attach $nsovs $ovspid

sudo docker exec ovs-test ovs-ctl start

sudo docker exec ovs-test ovs-vsctl del-br br0

sudo docker exec ovs-test ovs-vsctl add-br br0

sudo ip netns exec $nsovs ip link set lo up

# h1 (eth0) <--> hovs (hostovs1) 

let ns1 = "ns1"

let host1 = "host1"

sudo ip netns attach $ns1 $pid1

sudo ip link add $host1 type veth peer name ($hostovs + "1")

sudo ip link set $host1 netns $ns1

sudo ip link set ($hostovs + "1") netns $nsovs

sudo docker exec ovs-test ovs-vsctl add-port br0 ($hostovs + "1")

sudo ip netns exec $ns1 ip link set lo up

sudo ip netns exec $ns1 ip link set $host1 up

sudo ip netns exec $ns1  ip addr add 10.0.0.1/24 dev $host1

sudo ip netns exec $ns1 ip link set $host1 down

sudo ip netns exec $ns1 ip link set $host1 name eth0

sudo ip netns exec $ns1 ip link set eth0 up

sudo ip netns exec $nsovs ip link set ($hostovs + "1") up

# h2 (eth0) <--> hovs (hostovs2)

let ns2 = "ns2"

let host2 = "host2"

sudo ip netns attach $ns2 $pid2

sudo ip link add $host2 type veth peer name ($hostovs + "2")

sudo ip link set $host2 netns $ns2

sudo ip link set ($hostovs + "2") netns $nsovs

sudo docker exec ovs-test ovs-vsctl add-port br0 ($hostovs + "2")

sudo ip netns exec $ns2 ip link set lo up

sudo ip netns exec $ns2 ip link set $host2 up

sudo ip netns exec $ns2 ip addr add 10.0.0.2/24 dev $host2

sudo ip netns exec $ns2 ip link set $host2 down

sudo ip netns exec $ns2 ip link set $host2 name eth0

sudo ip netns exec $ns2 ip link set eth0 up

sudo ip netns exec $nsovs ip link set ($hostovs + "2") up

read()

sudo kill $pid1

sudo kill $pid2

sudo kill $ovspid

sudo ip netns del $ns1

sudo ip netns del $ns2

sudo ip netns del $nsovs

sudo ip link del $host1

sudo ip link del $host2

sudo ip link del $hostovs
